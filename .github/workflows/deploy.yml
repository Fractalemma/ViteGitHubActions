name: Deploy Vite App to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: my-vite-app/package-lock.json

    - name: Install dependencies
      working-directory: ./my-vite-app
      run: npm ci

    - name: Build Vite app
      working-directory: ./my-vite-app
      run: npm run build

    - name: Create deployment archive
      working-directory: ./my-vite-app
      run: |
        cd dist
        tar -czf ../vite-build.tar.gz .
        cd ..
        echo "Build size: $(du -h vite-build.tar.gz | cut -f1)"

    - name: Setup SSH key
      if: github.ref == 'refs/heads/main'
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        
        # Create the SSH key file using base64 encoding to avoid format issues
        echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/deploy_key 2>/dev/null || {
          # If base64 decode fails, try direct approach with better formatting
          printf '%s\n' "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        }
        
        # Ensure proper permissions
        chmod 600 ~/.ssh/deploy_key
        
        # Verify the key file format
        echo "SSH key file size: $(wc -c < ~/.ssh/deploy_key) bytes"
        echo "SSH key first line: $(head -n1 ~/.ssh/deploy_key)"
        echo "SSH key last line: $(tail -n1 ~/.ssh/deploy_key)"
        
        # Test the SSH key format and show more details if it fails
        if ! ssh-keygen -l -f ~/.ssh/deploy_key; then
          echo "‚ùå SSH key format is invalid!"
          echo "Key file contents (first 3 lines):"
          head -n3 ~/.ssh/deploy_key
          echo "..."
          echo "Key file contents (last 3 lines):"
          tail -n3 ~/.ssh/deploy_key
          echo ""
          echo "üîß Please ensure your DEPLOY_SSH_PRIVATE_KEY secret contains:"
          echo "1. The complete private key from -----BEGIN to -----END"
          echo "2. No extra spaces or characters"
          echo "3. Proper line breaks"
          exit 1
        fi
        
        # Add EC2 host to known hosts
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts"

    - name: Deploy to EC2
      if: github.ref == 'refs/heads/main'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # Test SSH connection first
        echo "Testing SSH connection to $EC2_USER@$EC2_HOST"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'SSH connection successful'"
        
        # Copy deployment script to server
        echo "Transferring deployment script to $EC2_USER@$EC2_HOST"
        scp -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./scripts/deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        
        # Copy build archive to server
        echo "Transferring build archive to $EC2_USER@$EC2_HOST"
        scp -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./my-vite-app/vite-build.tar.gz $EC2_USER@$EC2_HOST:/tmp/
        
        # Execute deployment script
        echo "Executing deployment script on $EC2_USER@$EC2_HOST"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"

    - name: Health check
      if: github.ref == 'refs/heads/main'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        # Wait a moment for deployment to complete
        sleep 10
        
        # Check if the website is accessible
        response=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST)
        if [ $response -eq 200 ]; then
          echo "‚úÖ Deployment successful! Website is accessible."
          echo "üåê Visit: http://$EC2_HOST"
        else
          echo "‚ùå Deployment may have failed. HTTP status: $response"
          exit 1
        fi