name: Deploy Vite App to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: my-vite-app/package-lock.json

    - name: Install dependencies
      working-directory: ./my-vite-app
      run: npm ci

    - name: Build Vite app
      working-directory: ./my-vite-app
      run: npm run build

    - name: Create deployment archive
      working-directory: ./my-vite-app
      run: |
        cd dist
        tar -czf ../vite-build.tar.gz .
        cd ..
        echo "Build size: $(du -h vite-build.tar.gz | cut -f1)"

    - name: Setup SSH key
      if: github.ref == 'refs/heads/main'
      run: |
        # Create SSH directory and key file
        mkdir -p ~/.ssh
        printf '%s\n' "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        sed -i '/^[[:space:]]*$/d' ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add EC2 host to known hosts
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts"

    - name: Deploy to EC2
      if: github.ref == 'refs/heads/main'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # Test SSH connection first
        echo "Testing SSH connection to $EC2_USER@$EC2_HOST"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'SSH connection successful'"
        
        # Copy deployment script to server
        echo "Transferring deployment script to $EC2_USER@$EC2_HOST"
        scp -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./scripts/deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        
        # Copy build archive to server
        echo "Transferring build archive to $EC2_USER@$EC2_HOST"
        scp -v -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./my-vite-app/vite-build.tar.gz $EC2_USER@$EC2_HOST:/tmp/
        
        # Execute deployment script
        echo "Executing deployment script on $EC2_USER@$EC2_HOST"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"