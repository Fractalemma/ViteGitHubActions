name: Deploy Vite App to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: my-vite-app/package-lock.json

    - name: Install dependencies
      working-directory: ./my-vite-app
      run: npm ci

    - name: Build Vite app
      working-directory: ./my-vite-app
      run: npm run build

    - name: Create deployment archive
      working-directory: ./my-vite-app
      run: |
        cd dist
        tar -czf ../vite-build.tar.gz .
        cd ..
        echo "Build size: $(du -h vite-build.tar.gz | cut -f1)"

    - name: Setup SSH key
      if: github.ref == 'refs/heads/main'
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        
        # Add private key to a file with proper formatting
        echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Verify the key file was created properly
        echo "SSH key file size: $(wc -c < ~/.ssh/deploy_key) bytes"
        echo "SSH key first line: $(head -n1 ~/.ssh/deploy_key)"
        
        # Add EC2 host to known hosts to avoid host key verification
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts"

    - name: Deploy to EC2
      if: github.ref == 'refs/heads/main'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # Copy deployment script to server
        echo "Transferring deployment script to $EC2_USER@$EC2_HOST"
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./scripts/deploy.sh $EC2_USER@$EC2_HOST:/tmp/
        
        # Copy build archive to server
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ./my-vite-app/vite-build.tar.gz $EC2_USER@$EC2_HOST:/tmp/
        
        # Execute deployment script
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"

    - name: Health check
      if: github.ref == 'refs/heads/main'
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        # Wait a moment for deployment to complete
        sleep 10
        
        # Check if the website is accessible
        response=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_HOST)
        if [ $response -eq 200 ]; then
          echo "‚úÖ Deployment successful! Website is accessible."
          echo "üåê Visit: http://$EC2_HOST"
        else
          echo "‚ùå Deployment may have failed. HTTP status: $response"
          exit 1
        fi